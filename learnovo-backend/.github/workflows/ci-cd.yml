name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:4.4
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linting
      run: npm run lint
    
    - name: Run unit tests
      run: npm run test:unit
      env:
        NODE_ENV: test
        MONGODB_TEST_URI: mongodb://localhost:27017/learnovo_test
        JWT_SECRET: test-secret-key
    
    - name: Run integration tests
      run: npm run test:integration
      env:
        NODE_ENV: test
        MONGODB_TEST_URI: mongodb://localhost:27017/learnovo_test
        JWT_SECRET: test-secret-key
    
    - name: Generate coverage report
      run: npm run test:ci -- --coverage
      env:
        NODE_ENV: test
        MONGODB_TEST_URI: mongodb://localhost:27017/learnovo_test
        JWT_SECRET: test-secret-key
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

  build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --only=production
    
    - name: Build application
      run: |
        echo "Application built successfully"
        echo "Node.js version: $(node --version)"
        echo "NPM version: $(npm --version)"
    
    - name: Create deployment package
      run: |
        tar -czf learnovo-backend.tar.gz \
          --exclude=node_modules \
          --exclude=.git \
          --exclude=tests \
          --exclude=coverage \
          --exclude=.eslintrc.js \
          --exclude=jest.config.js \
          .

  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Run security audit
      run: npm audit --audit-level moderate
    
    - name: Check for known vulnerabilities
      run: |
        if npm audit --audit-level moderate --json | jq '.vulnerabilities | length' | grep -q '[1-9]'; then
          echo "Security vulnerabilities found!"
          exit 1
        else
          echo "No security vulnerabilities found"
        fi

  deploy-staging:
    runs-on: ubuntu-latest
    needs: [test, build, security]
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to staging
      run: |
        echo "Deploying to staging environment..."
        echo "This would typically involve:"
        echo "1. Connecting to staging server"
        echo "2. Running database migrations"
        echo "3. Deploying application code"
        echo "4. Restarting services"
        echo "5. Running health checks"

  deploy-production:
    runs-on: ubuntu-latest
    needs: [test, build, security]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to production
      run: |
        echo "Deploying to production environment..."
        echo "This would typically involve:"
        echo "1. Connecting to production server"
        echo "2. Running database migrations"
        echo "3. Deploying application code"
        echo "4. Restarting services"
        echo "5. Running health checks"
        echo "6. Sending deployment notifications"

  notify:
    runs-on: ubuntu-latest
    needs: [test, build, security]
    if: always()
    
    steps:
    - name: Notify on success
      if: ${{ needs.test.result == 'success' && needs.build.result == 'success' && needs.security.result == 'success' }}
      run: |
        echo "✅ All checks passed! Pipeline successful."
    
    - name: Notify on failure
      if: ${{ needs.test.result == 'failure' || needs.build.result == 'failure' || needs.security.result == 'failure' }}
      run: |
        echo "❌ Pipeline failed. Please check the logs."
        exit 1
